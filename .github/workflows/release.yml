name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-cli:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Build universal CLI binary
        run: |
          swift build -c release --arch arm64 --arch x86_64
          mkdir -p dist
          cp .build/apple/Products/Release/handoff dist/
          cd dist && tar -czvf handoff-${GITHUB_REF_NAME}-universal.tar.gz handoff
          shasum -a 256 handoff-${GITHUB_REF_NAME}-universal.tar.gz > handoff-${GITHUB_REF_NAME}-universal.tar.gz.sha256

      - uses: actions/upload-artifact@v4
        with:
          name: cli
          path: dist/*

  build-app:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Build macOS app
        run: |
          xcodebuild -project Handoff.xcodeproj \
            -scheme SharedClipboard \
            -configuration Release \
            -archivePath Handoff.xcarchive \
            archive

          xcodebuild -exportArchive \
            -archivePath Handoff.xcarchive \
            -exportPath export \
            -exportOptionsPlist ExportOptions.plist

      - name: Create DMG
        run: |
          mkdir -p dmg-contents dist
          cp -R export/Handoff.app dmg-contents/
          hdiutil create -volname "Handoff" -srcfolder dmg-contents -ov -format UDZO dist/Handoff-${GITHUB_REF_NAME}.dmg
          shasum -a 256 dist/Handoff-${GITHUB_REF_NAME}.dmg > dist/Handoff-${GITHUB_REF_NAME}.dmg.sha256

      - uses: actions/upload-artifact@v4
        with:
          name: app
          path: dist/*

  release:
    needs: [build-cli, build-app]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            cli/*
            app/*
          generate_release_notes: true

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Update formula and cask with new SHA256
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          # Download SHA files using gh CLI
          gh release download ${GITHUB_REF_NAME} --pattern "*.sha256" --dir /tmp/sha
          CLI_SHA=$(cat /tmp/sha/handoff-*.sha256 | awk '{print $1}')
          APP_SHA=$(cat /tmp/sha/Handoff-*.sha256 | awk '{print $1}')

          # Update Formula
          sed -i "s|url \".*\"|url \"https://github.com/Michaelliv/handoff/releases/download/${GITHUB_REF_NAME}/handoff-${GITHUB_REF_NAME}-universal.tar.gz\"|" Formula/handoff-cli.rb
          sed -i "s/sha256 \".*\"/sha256 \"${CLI_SHA}\"/" Formula/handoff-cli.rb
          sed -i "s/version \".*\"/version \"${VERSION}\"/" Formula/handoff-cli.rb

          # Update Cask
          sed -i "s|url \".*\"|url \"https://github.com/Michaelliv/handoff/releases/download/${GITHUB_REF_NAME}/Handoff-${GITHUB_REF_NAME}.dmg\"|" Casks/handoff.rb
          sed -i "s/version \".*\"/version \"${VERSION}\"/" Casks/handoff.rb
          sed -i "s/sha256 \".*\"/sha256 \"${APP_SHA}\"/" Casks/handoff.rb

      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add Formula/ Casks/
          git commit -m "Update Homebrew to ${GITHUB_REF_NAME}" || exit 0
          git push
